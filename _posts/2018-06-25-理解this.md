---
layout: post
title: "理解this"
date: 2018-06-25 
description: "JavaScript,this"
tag: JavaScript
---   

this是前端中的一个重要概念，如果不好好理解this，则有可能在编写代码的过程中出现各种'xxx is not defined in this'的错误。下面就总结一下this的各种用法和注意事项。

### this是什么?

this是JavaScript的一个关键字,它是在函数运行时其内部的一个环境对象，它只能在函数体内使用。

在JavaScript语言中,this是在运行期才被绑定,所以要注意函数的调用方式。

**1.直接调用**

当函数被直接调用时，其中的this绑定到全局对象，即window。

	function foo(){
	  this.name='john';
	}
	foo();//此时name已经成为一个全局变量
	console.log(window.name);//'john'

**2.被对象调用**

当函数被一个对象调用时，函数内的this指向该对象。

	var person={
	  name:'john',
	  getName:function(){
		console.log(this.name);
	  }
	}
	person.getName();//'john'

**3.作为构造函数调用**

当函数被用来生成一个新对象时，函数内的this指向这个新的对象。

	function Person(){
	  this.name='john';
	}
	var person=new Person();
	person.name;//'john'

**4.apply和call调用**

当函数被apply或call调用时，则this就绑定为apply或call函数的第一个参数。

	var name='john';
	function person(){
	  console.log(this.name);
	}
	var user={
	  name:'tom'
	}
	person.apply(obj);//'tom'

### ES6箭头函数中的this

ES6将函数简化为箭头函数

	var fn=()=>{
	  this.name='john'
	}

需要注意的是，箭头函数中的this对象，在**定义**箭头函数的时候就已经确定了this的绑定，即其定义时所在的对象，而不是运行时确定。

	function foo(){
	  setTimeout(() => {
	    console.log("id:", this.id)
	  }, 100);
	}
	
	foo.call({id:42});//在运行这行时，箭头函数开始被定义，其this绑定到foo的this，而foo的this为{id:42}

### React中的this绑定

在React的开发过程中，经常会遇到this。当使用class的方式编写组件时，需要手动绑定this，有三种常见的绑定方式：

**方法1，调用时用bind方法绑定：**

	class Test extends React.Component {
	  handleClick(msg){
		this.setState({
		  msg
		})
	  }
	  render(){
		return(
			<button onClick={this.handleClick.bind(this,'hello')}>click me!</button>
		)
	  }
	｝

**方法2，在构造函数内绑定：**


	class Test extends React.Component {
	  constructor(p){
		super(p);
		this.handleClick=this.handleClick.bind(this)
	  }
	  handleClick(msg){
		this.setState({
		  msg
		})
	  }
	  render(){
		return(
			<button onClick={this.handleClick.bind(this,'hello')}>click me!</button>
		)
	  }
	｝

**方法3，使用箭头函数：**

	class Test extends React.Component {
	  constructor(p){
		super(p);
		this.handleClick=this.handleClick.bind(this)
	  }
	  handleClick(msg){
		this.setState({
		  msg
		})
	  }
	  render(){
		return(
			<button onClick={()=>this.handleClick('hello'))}>click me!</button>
		)
	  }
	｝

### this的例子
**例1**

	foo = function(){
	    this.myName = "Foo function.";
	}
	foo.prototype.sayHello = function(){
	    alert(this.myName);
	}
	foo.prototype.bar = function(){
	    setTimeout(this.sayHello, 1000);
	}
	var f = new foo;
	f.bar();

>setTimeout中的this.sayHello运行时为在异步队列中，此时的this绑定到全局对象中，而全局对象中并没有myName变量，因此输出undefined

**例2**

	document.getElementById( 'div1' ).onclick = function(){
	    console.log( this.id );// 输出: div1
	    var func = function(){ 
	        console.log ( this.id );
	    } 
	    func();// 输出: undefined，此时func()为普通调用，this指向全局对象
	}; 

**例3**

	function foo() {
	    console.log( this.a );
	}
	var a = 2;
	var o = { a: 3, foo: foo };
	var p = { a: 4 };
	o.foo(); // 3，对象调用，this指向o对象
	(p.foo = o.foo)(); // 2，普通调用，this指向全局对象



参考：
[1].阮一峰，ECMAScript 6 入门[M].http://http://es6.ruanyifeng.com
